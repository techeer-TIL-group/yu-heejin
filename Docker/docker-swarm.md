## Container Orchestration

- 컨테이너 오케스트레이션이란 컨테이너의 배포, 관리, 확장, 네트워킹을 자동화하는 것이다.

### 컨테이너 오케스트레이션이 수행하는 작업

- 프로비저닝 및 배포
- 구성 및 일정 조정
- 리소스 할당
- 컨테이너 가용성
- 컨테이너 스케일링 또는 제거
- 로드 밸런싱 및 트래픽 라우팅
- 컨테이너 모니터링
- 실행된 컨테이너를 기반으로 애플리케이션 설정
- 컨테이너간 보안 유지

## Docker Swarm

- 일반적으로 Docker 사용법은 하나의 호스트를 기준으로 한다.
- `docker ps`, `docker run`, `docker create` 등과 같은 명령어들은 모두 하나의 컨테이너를 대상으로 실행된다.
- 하지만 실제로 도커를 운영 환경에 적용한다고 한다면, 하나의 호스트에 도커를 설치해 운영하는 것은 어렵다.
    - 단일 호스트로 구성된 환경은 확장성(Scalability), 가용성(Availability), 장애 허용성(Fault Tolerance) 측면에서 많은 한계점을 가진다.
    - 이를 해결하기 위해 가장 많이 사용되는 방법은 **여러 대의 서버를 하나의 클러스터로 묶어 리소스를 병렬로 확장하는 것이다.**
- 도커 스웜은 이처럼 **서로 다른 호스트에 있는 여러 대의 컨테이너를 하나로 묶어 마치 하나의 호스트인 것처럼 사용할 수 있도록** 도와주는 컨테이너 오케스트레이션 도구이다.

### 장점

- 쿠버네티스만큼은 아니더라도, 여러 대의 호스트로 구성된 중소 규모의 클러스터에서 컨테이너 기반 애플리케이션 구동을 제어하기에 충분한 기능을 갖추고 있다.
- 도커 엔진이 설치된 환경이라면, 별도의 구축 비용 없이 스웜 모드를 활성화하는 것만으로도 가능하다.
- Docker compose를 사용해본 사람이라면 도커 스웜의 스택(stack)을 이용한 애플리케이션 운영에 곧바로 적응할 수 있다.
- Docker desktop으로도 클러스터 관리와 배포가 모두 가능한 단일 노드 클러스터를 바로 만들 수 있다.
    - 따라서 최소한의 자원으로 컨테이너 오케스트레이션 환경을 만들어 실험해볼 수 있다.

## 주요 용어

- 노드(Node): 클러스터를 구성하는 개별 도커 서버를 의미한다.
- 매니저 노드(Manager Node): 클러스터 관리와 컨테이너 오케스트레이션을 담당한다.
    - 쿠버네티스의 마스터 노드와 같은 역할이라고 할 수 있다.
- 워커 노드(Worker Node): 컨테이너 기반 서비스들이 실제 구동되는 노드를 의미한다.
    - 쿠버네티스와 다른 점이 있다면, Docker swarm에서는 매니저 노드도 기본적으로 워커 노드의 역할을 같이 수행할 수 있다.
    - 스케줄링을 임의로 막는 것도 가능하다.
- 스택(Stack): 하나 이상의 서비스(Service)로 구성된 다중 컨테이너 애플리케이션 묶음을 의미한다.
    - 도커 컴포즈와 유사한 양식의 yaml 파일로 스택 배포를 진행한다.
- 서비스(Service): 노드에서 수행하고자 하는 작업들을 정의해놓은 것으로, **클러스터 안에서 구동시킬 컨테이너 묶음을 정의한 객체이다.**
    - 도커 스웜에서의 기본적인 배포 단위로 취급된다.
    - 하나의 서비스는 하나의 이미지를 기반으로 구동되며, 이들 각각이 전체 애플리케이션의 구동에 필요한 개별적인 마이크로서비스(microservice)로 기능한다.
- 테스크(Task): 클러스터를 통해 서비스를 구동시킬 때, 도커 스웜은 해당 서비스의 요구 사항에 맞춰 실제 마이크로서비스가 동작할 도커 컨테이너를 구성하여 노드에 분배하는데, 이를 테스크라고 한다.
    - 하나의 서비스는 지정된 복제본(replica) 수에 따라 여러 개의 테스크를 가질 수 있으며, 각각의 테스크에는 하나씩의 컨테이너가 포함된다.
- 스케줄링(Scheduling): 서비스 명세에 따라 테스크를 노드에 분배하는 작업을 의미한다.
    - 2022년 8월 기준으로 도커 스웜에서는 오직 균등 분배(spread) 방식만 지원하고 있다.

## Docker Swarm 구조

### 분산 코디네이터(Distributed Coordinator)

- 여러 개의 도커 서버를 하나의 클러스터로 구성하기 위해 각종 정보를 저장하고 동기화한다.

### 에이전트

- 각 서버를 제어하는 역할을 한다.

### 워커 노드

- 실제 컨테이너가 생성되고 관리되는 도커 서버이다.
- 워커 노드는 없을 수도 있다.

### 매니저 노드

- 클러스터 내의 워커 노드를 관리하기 위한 도커 서버이다.
- 매니저 노드는 워커 노드의 역할도 포함하고 있다.
- 매니저 노드는 무조건 1개 이상 존재해야 한다.

## Swarm classic vs Swarm mode

- 도커 스웜에는 스웜 클래식, 스웜 모드 두 종류가 있다.
- **스웜 클래식은 여러 대의 도커 서버를 하나의 지점에서 사용할 수 있도록 단일 접근점을 제공**한다면, **스웜 모드는 마이크로 아키텍처의 컨테이너를 다루기 위한 클러스터링 기능**에 초점을 맞추고 있다.
- 스웜 모드가 서비스 확장성과 안정성 등 여러 측면에서 스웜 클래식보다 뛰어나기 때문에 일반적으로 스웜 모드를 더 많이 사용한다.

### 스웜 클래식

- 도커 버전 1.6 이후부터 사용할 수 있다.
- `docker run`, `docker ps` 등 일반적인 도커 명령어와 도커 API로 클러스터의 서버를 제어하고 관리할 수 있는 기능을 제공한다.
- 분산 코디네이터, 에이전트 등을 별도로 실행해야 한다.

### 스웜 모드

- 도커 버전 1.12 이후부터 사용할 수 있다.
- 같은 컨테이너를 여러개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절할 수 있으며, 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 자체적으로 지원한다.
- 분산 코디네이터, 에이전트 등이 모두 도커 엔진 자체에 내장되어 있다.

## 참고 자료

- https://yoo11052.tistory.com/181
- https://seongjin.me/docker-swarm-introduction-nodes/