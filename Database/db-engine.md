## 스토리지 엔진(DB 엔진)

- **서버 엔진이 필요한 물리적인 데이터를 가져오는 장치**
    - 데이터베이스에서 데이터를 접근하는 방식을 의미한다.
- 데이터베이스 관리 시스템(DBMS)이 데이터베이스에 대해 **데이터를 삽입, 추출, 업데이트 및 삭제(CRUD)하는데 사용되는 기본 소프트웨어 컴포넌트이다.**
- Mysql에서 테이블을 생성하면 실제로 서버상에서는 .frm이라는 파일을 생성하는데, **이 파일에 접근하는 속성을 설정하는 것이 바로 스토리지 엔진이다.**
- 저장 엔진은 **동일 DB 내의 테이블마다 다르게 지정이 가능**하다.

## 스토리지 엔진의 역할

### 트랜잭션(Transaction)

- 트랜잭션을 스케줄링하고 데이터베이스 상태의 논리적 일관성 보장

### 잠금 매니저(lock manager)

- 트랜잭션에서 접근하는 데이터베이스 객체에 대한 잠금을 제어한다.
- 동시 수행 작업이 물리적 데이터 무결성을 침해하지 않도록한다.
- 트랜잭션과 잠금 매니저는 **동시성 제어, 논리적/물리적 데이터 무결성을 보장**하고 **동시 수행 작업의 효율적 수행을 담당**한다.

### 엑세스 메서드(access method)

- 디스크에 저장된 데이터에 대한 접근 및 저장 방식을 정의한다.
- 힙 파일, B-tree, LSM tree 등의 자료구조 사용

### 버퍼 매니저(buffer manager)

- 데이터 페이지를 메모리에 캐시

### 복구 매니저(recovery manager)

- 로그를 유지 관리하고 장애 발생 시 시스템을 복구

## 스토리지 엔진의 종류

- SELECT가 주로 일어나는 테이블일 경우 MyISAM, UPDATE/INSERT/DELETE가 일어나는 테이블일 경우 InnoDB를 사용한다.

### MyISAM

- **정적인 데이터를 저장하고 자주 읽기 작업이 일어나는 테이블에 적합**하다.
- MySQL의 기본 스토리지 엔진
- 구조가 단순하고 속도가 빠르다.
- 데이터 저장에 실제적인 제한이 없고 매우 효율적으로 저장한다.
    - 메모리 효율이 InnoDB보다 좋다.
- 테이블 작업 시 특정 행을 수정하려고 하면 **테이블 전체에 락**이 걸리기 때문에 다른 사람이 작업할 수 없다. (Table-Level Lock)
    - **갱신이 많은 용도로는 성능적으로 불리하며, 동시 서비스에 적합하지 않다.**
    - multi-thread 환경에서는 성능이 저하될 수 있다.
- **트랜잭션에 대한 지원이 없기 때문**에 작업 도중 문제가 생겨도 이미 DB안으로 데이터가 들어간다.
    - DB 프로세스가 비정상 종료되면 테이블이 파손될 가능성이 높다.
    - 즉, 데이터의 무결성이 보장되지 않는다. (동시성 제어가 어렵다.)
    - 하지만 InnoDB보다 심플하고 빠르다.
- full-text 검색이 가능하다.
- 주로 SELECT 작업이 많은 경우 사용된다.
- InnoDB의 버퍼풀과 비슷한 역할을 하는 것이 **MyISAM의 Key Cache**이다.
    - 하지만 인덱스만 대상으로 작동하며, 인덱스의 디스크 쓰기 작업에 대해서만 부분적으로 버퍼링 역할만 한다.

### InnoDB

- **데이터 입력 및 수정이 빈번한 높은 퍼포먼스를 요구**하고 **다중 사용자, 동시성이 높은 OLTP 애플리케이션에 적합**하다.
- 트랜잭션을 처리하기 위해 고안되었는데, 대부분의 경우 **롤백되지 않고 완료되는 짧은 트랜잭션이 많은 경우를 처리하기 좋다.**
- MariaDB의 기본 스토리지 엔진
- MyISAM보다 데이터 저장 비율이 낮고, 데이터 로드 속도가 느리다.
- **레코드 기반 락(Lock)**을 제공한다.
    - 즉 테이블 레벨이 아닌 **ROW 레벨의 락**을 지원한다.
    - 이로 인해 **높은 동시성 처리가 가능하며 안정적**이다.
- **MVCC(Multi Version Concurrency Control) 기술을 이용해 락을 걸지 않고 읽기 작업을 수행**한다.
    - 락을 걸지 않기 때문에 InnoDB에서 읽기 작업은 다른 트랜잭션이 가지고 있는 락을 기다리지 않아도 된다.
- 외래키를 지원한다.
    - MyISAM이나 MEMORY 테이블에서는 사용할 수 없다.
    - 외래키는 여러가지 제약사항으로 인해 실무에서는 잘 사용하지 않기 때문에 필수적이지는 않지만, 개발 환경의 데이터베이스에서는 좋은 가이드 역할을 할 수 있다.
- 자동 데드락 감지
    - 감지 시 **변경된 레코드가 가장 작은 트랜잭션을 롤백**하여 데드락을 풀어준다.
    - **그래프 기반의 데드락 체크 방식**을 사용하기 때문에 **데드락이 발생함과 동시에 바로 감지**되고, 감지된 데드락은 관련 트랜잭션 중에서 **ROLLBACK이 가장 용이한 트랜잭션을 강제로 종료한다.**
    - 따라서 데드락 때문에 쿼리가 타임아웃 또는 슬로우 쿼리로 기록되는 경우는 많지 않다.
- 자동 장애 복구
    - 완료하지 못한 트랜잭션이나 일부만 기록되어 손상된 데이터 페이지 등을 자동 복구한다.
    - 손실이나 장애로부터 데이터를 보호하기 위해 여러 메커니즘이 탑재되어 있으며, **MySQL 서버가 시작될 때 완료되지 못한 트랜잭션이나 디스크에 일부만 기록된 트랜잭션 등에 대한 일련의 복구 작업이 자동으로 진행**된다.
- **데이터 무결성 보장**
    - 트랜잭션, 외래키, 제약조건, 동시성 등
    - **ACID 트랜잭션을 지원**하는 대표적인 MySQL의 뛰어난 성능과 장애 복구 기능을 가진 엔진이다.
    - 결제 정보와 같이 정보의 **무결성을 가져야하고 손실되면 안되는 중요한 데이터를 필요로 할 때 사용한다.**
- **Primary Key를 기준으로 Clusturing**되어 저장된다.
    - 즉, **PK를 기준으로 순서대로 디스크에 저장되는 구조**로, **PK에 의한 Range Scan이 빠르다.**
    - 데이터를 PK 순서에 맞게 저장하기 때문에 ORDER BY 등 쿼리에 유리할 수 있다.
- 클러스터 인덱스(clustered index) 위에 구성되어 있으며, **인덱스 구조는 대부분의 MySQL 스토리지 엔진의 인덱스 구조와 매우 상이하다.**
    - 따라서 매우 신속한 기본 키 조회가 가능하다.
    - 하지만 보조 인덱스(기본 키가 아닌 인덱스)는 기본 키 행을 포함하므로, 만약 기본 키가 크다면 다른 인덱스도 크기 때문에 테이블이 여러 인덱스를 가진다면 기본키가 작은 값을 갖게 해야한다.
- 인덱스와 더불어 **데이터까지 버퍼풀에 저장하기 때문에 모든 데이터가 메모리에 있으면 디스크를 읽지 않아도 된다.**
    - 데이터 접근 속도가 빠르다.
    - 인덱스와 데이터 모두 메모리에 적재되므로 메모리 사용 효율에 좋지 않다.
    - 메모리 때문에 로그 수집에 대한 용도로 InnoDB를 사용하면 안된다.

### Archive

- 로그 수집에 적합한 엔진
- 자동적으로 데이터 압축을 지원하며 다른 엔진에 비해 80% 저장공간 절약 효과를 자랑한다.
- 데이터가 메모리상에서 압축되고, 압축된 상태로 디스크에 저장되기 때문에 row-level locking이 가능하다.
- 가장 빠른 데이터 로드 속도 또한 자랑하지만, INSERT와 SELECT만이 가능하다.
- 트랜잭션을 지원하지 않는다.

### Cluster(NDB)

- 트랜잭션을 지원한다.
- 모든 데이터와 인덱스가 메모리에 존재하며, 매우 빠른 데이터 로드 속도를 자랑하며 PK 사용시 최상의 속도를 나타낸다.

### Federated

- 물리적 데이터베이스에 대한 논리적 데이터베이스를 생성하여 원격 데이터를 컨트롤 할 수 있다.
- 실행 속도는 네트워크 요소에 따라 좌우되고 테이블 정의를 통한 SSL 보안 처리를 한다.
- 분산 데이터베이스 환경에 사용한다.

## 참고 자료

- [https://velog.io/@sweet_sumin/DB-스토리지-엔진-별-차이](https://velog.io/@sweet_sumin/DB-%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%80-%EC%97%94%EC%A7%84-%EB%B3%84-%EC%B0%A8%EC%9D%B4)
- [https://nomadlee.com/mysql-스토리지-엔진-종류-및-특징/](https://nomadlee.com/mysql-%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%80-%EC%97%94%EC%A7%84-%EC%A2%85%EB%A5%98-%EB%B0%8F-%ED%8A%B9%EC%A7%95/)
- https://gocoder.tistory.com/2393