## 트랜잭션(Transaction)

- 우리는 데이터베이스에 삽입, 수정, 삭제 등의 작업을 할 때 여러 개의 작업들을 하나의 트랜잭션으로 묶는다.
- 즉, **트랜잭션은 DBMS에서 데이터를 다루는 논리적인 작업의 단위**가 된다.
- 예를 들어, A계좌에서 B계좌로 돈을 이체하는 경우에 이 업무는 A에서 돈을 빼고 B에서 돈을 더하는 두 가지의 `Update`문으로 나뉘게 된다.
    - 이 때 각 `Update`는 개별적으로 수행되는 것이 아니라 하나의 트랜잭션으로 묶이게 되며, 하나의 트랜잭션이 실행될 때 이 2개의 SQL문이 연속적으로 실행된다.
    - 그러므로 2개의 Update문이 하나의 트랜잭션으로 묶여있다고 가정할 때 1개의 SQL만 실행되는 상황은 발생되지 않고, 이를 All or Nothing이라고 한다.

## 트랜잭션 수행 과정

1. A계좌의 값을 하드디스크(데이터베이스)에서 주기억장치(버퍼)로 읽어온다.
2. B계좌의 값을 하드디스크(데이터베이스)에서 주기억장치(버퍼)로 읽어온다.
3. A계좌에서 10000원을 인출한 값을 저장한다.
4. B계좌에서 10000원을 입금한 값을 저장한다.
5. A계좌의 값을 버퍼에서 데이터베이스에 기록한다.
6. B계좌의 값을 버퍼에서 데이터베이스에 기록한다.

### COMMIT

![Untitled](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F99052D415A2F89440B)

- 트랜잭션의 수행이 완료됨을 트랜잭션 관리자에게 알려주는 연산이다.
- 4번까지 수행 후 commit할 수 있고, 6번까지 수행 후 commit할 수 있다.

## ACID 성질

### 원자성(Atomicity)

- 트랜잭션에 포함된 작업은 전부 수행되거나 전부 수행되지 않아야한다. (All or Nothing)
- 트랜잭션이 원자처럼 더이상 쪼개지지 않는 하나의 프로그램 단위로 동작해야한다.

### 일관성(Consistency)

- 트랜잭션을 수행하기 전이나 후나 데이터베이스는 항상 일관된 상태를 유지해야한다.
- 기본키와 같은 속성같은 상태에는 변함이 없어야한다.

### 고립성(Isolation)

- 수행중인 트랜잭션에 다른 트랜잭션이 끼어들어 변경중인 데이터 값을 훼손하지 않아야한다.
- 즉, 부분 실행결과는 다른 트랜잭션이 볼 수 없다.
- 여러 트랜잭션이 동시에 수행될 때 각 트랜잭션은 상호간의 존재를 모르고 독립적으로 수행되어야한다.
- 여러 트랜잭션이 동시에 접근하는 데이터에 대한 제어가 필요하다.

### 지속성(Durability)

- 수행을 성공적으로 완료한 트랜잭션은 변경한 데이터를 영구히 저장해야한다.
- 트랜잭션이 정상적으로 완료된 경우에는 버퍼의 내용을 하드 디스크에 확실하게 기록해야하며, 부분 완료된 경우에는 작업을 취소해야한다.

## DBMS

![Untitled](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F994CAA425A2F96501C)

- DBMS는 원자성을 유지하기 위해 회복 관리자 프로그램을 작동시킨다.
    - 일부만 진행된 트랜잭션을 취소시켜 원자성을 유지할 뿐만 아니라 값을 트랜잭션 이전 상태로 복원시켜 지속성을 유지해준다.
- DBMS는 일관성을 유지하기 위해 동시성 제어 알고리즘과 무결성 제약조건을 사용한다.
    - 무결성 제약 조건은 잘못된 값에 대한 입력이 오지 않도록한다.
- DBMS는 고립성을 유지하기 위해 동시성 제어 알고리즘을 작동시킨다.
    - Locking을 통해 이를 만족시킨다.
- DBMS는 지속성을 유지하기 위해 회복 관리자 프로그램을 이용한다.

## Rollback

![Untitled](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F99F5A8435A2F9A6F1E)

- 트랜잭션 실행 중 장애가 발생한 경우 수행된다.
- commit 이전에 데이터 변경 사항이 취소되어 이전 상태로 복구되며, 관련 행에 대한 잠금이 풀리는 것
- 장애가 발생한 경우는 데이터 베이스에 일부만 반영되어 일관되지 못한 상태를 가질 수 있기 때문에 모두 취소하거나 트랜잭션을 재시작해야한다.
- 트랜잭션은 활동(Active), 부분 완료(Partially Commited), 완료(Committed), 실패(Failed), 철회(Aborted)의 5가지 상태를 가지게 된다.
    - 활동: 트랜잭션이 begin_transaction으로부터 실행을 시작했거나 실행중인 상태를 의미한다.
    - 부분 완료: 마지막 명령문을 실행시킨 직후의 상태를 의미하며, 실패 또는 완료의 상태로 전이하게 된다.
    - 실패:  트랜잭션 실행 중에 장애나 오류가 발생하여 정상적인 실행을 할 수 없는 상태이며, rollback 연산을 수행한 상태인 철회 상태로 전이하게 된다.
- 철회의 원인이 트랜잭션 자체의 논리적인 오류가 아닌 경우에는 재시작되며, 트랜잭션 철회 원인이 트랜잭션 내부의 논리적인 오류에 의해 오류를 수정해야하는 상황이거나 얻고자하는 데이터가 데이터베이스에 존재하지 않는 경우 강제 종료된다.

## savePoint

- 저장점(savepoint)를 정의하면 롤백할 때 트랜잭션에 포함된 전체 작업을 롤백하는 것이 아니라 현 시점에서 savepoint까지 트랜잭션의 일부만 롤백할 수 있다.

## 참고 자료

- https://hoon93.tistory.com/24
- https://mangkyu.tistory.com/30
- https://wonit.tistory.com/462
- https://devjem.tistory.com/27