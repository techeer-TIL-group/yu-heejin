## 데몬(Daemon) 프로세스

- 리눅스 운영체제에서 사용하는 프로세스의 일종으로, 시스템이 시작할 때 같이 시작하여, 백그라운드에서 동작한다.
- 시스템을 종료할 때까지 종료되지 않는다.

## 특징

```bash
PPID   PID  PGID   SID TTY      TPGID STAT   UID   TIME COMMAND
1     4     1     1 ?           -1 SW       0   0:04 [keventd]
1     7     1     1 ?           -1 SW       0   8:25 [kswapd]
2182  2382  2382  2182 pts/13    2400 S      528   0:00 ./test_proc
```

- 가장 마지막에 있는 프로세스가 백그라운드 프로세스이다.
- **Daemon은 첫째 TTY(터미널 장치)를 가지고 있지 않다.**
- PPID가 1이며, SID 역시 자신의 아이디와 같다.

## 데몬 프로세스 만들기

1. `fork()`를 이용해 PPID를 1로 설정한다.
    1. 한 프로세스가 자식 프로세스를 만들고, 자식 프로세스가 소멸되기 전에 부모 프로세스가 사라지면, **자식 프로세스는 init 프로세스에 입양되어 PPID가 1이 된다.**
2. `fork()` 되는 경우 자식 프로세스는 새로운 프로세스 아이디를 받지만, 그룹 아이디는 부모의 것을 그대로 상속받게 된다.
    1. 즉, 그룹의 리더가 아니며, 부모 프로세스를 없애고 setsid()를 호출하는 것인 필수이다.
3. `setsid()`
    1. 호출하는 프로세스가 그룹의 리더가 아닐 때 새로운 세션을 생성하여 다음 일을 수행한다.
        1. 호출한 프로세스는 새로운 세션의 리더가 된다.
        2. 호출한 프로세스는 새로운 그룹의 리더가 된다.
        3. 프로세스는 컨트롤 터미널을 잃어버리게 된다.
    
    <aside>
    💡 session: 하나 이상의 프로세스 그룹 집합
    
    </aside>
    
4. `chdir()` 디렉토리 변경
    1. 부모로부터 물려받은 워킹 디렉토리는 파일 시스템에 마운트되어 있는 것일 수도 있고, 시스템이 정지할 때까지 살아 있는 Daemon의 특성 때문에 파일 시스템이 언마운트되지 않을 수 있다.
5. 불필요한 파일 디스크립터 삭제
    1. 데몬 프로세스는 컨트롤 터미널을 가지지 않는다.
    2. 이는 시스템 시작 시 아무도 몰래 실행되어 시스템이 죽을 때 그 운명을 같이 하는 데몬 프로세스를 사용자들이 알 필요가 없고 컨트롤 할 필요가 없기 때문이다.
6. 사라지지 않는 파일 디스크립터는 `/dev/null`

## Daemon과 Background Process 차이점

### Daemon

- 일반적으로 데몬은 터미널을 갖지 않는다.
    - 유저와 상호작용하지 않는다.
- 데몬 그 자체로 Process Group Leader로 1번 pid를 갖는 init으로 설정된다.
    - 즉, 독자적인 세션을 가지고 있으며, Linux system 자체가 아닌 별도의 독립된 Parent process를 갖지 않는다.
- 리눅스 cron과 같은 스케줄링 & 모니터링 프로세스들은 바로 이러한 데몬 형태를 띈다.

### Background

- 터미널을 통해 상호작용이 가능하다.
- 별도의 Parent process를 가질 수 있으며, Parent process와 세션이 공유되기 때문에 Parent signal의 영향을 받는다.

## 더 알아봐야할 점

- 컨트롤 터미널이란?
- 프로세스를 왜 두번 `fork()`하는지?

## 참고 자료

- https://kukuta.tistory.com/386
- https://jins-dev.tistory.com/32
- https://stackoverflow.com/questions/4192472/why-do-daemons-fork